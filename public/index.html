<!DOCTYPE html>
<html>
  <head>
    <script lang="text/javascript" src="/socket.io/socket.io.js"></script>
    <script src="/simple-peer/simplepeer.min.js"></script>
    <style>
      body {
        background-color: black;
        font-family: Arial, sans-serif;
        color: white;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }

      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgb(56, 56, 56);
        width: 100%;
      }

      .vid {
        flex: 0 1 auto;
        height: 400px;
        position: relative; /* To position the select box */
      }

      .settings.red {
        color: red; /* Text color red when disabled */
      }

      .vid-container {
        position: relative;
      }

      .select-box {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
      }

      .button-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .settings {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        font-size: 14px;
        cursor: pointer;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        transition: background 0.3s ease, color 0.3s ease;
      }

      .settings:hover {
        background: rgba(255, 255, 255, 0.4);
        color: black;
      }

      #videos {
        margin-bottom: 20px;
      }
      #localVideo {
        position: fixed; /* Position fixed to the viewport */
        bottom: 20px; /* 10px from the bottom */
        right: 20px; /* 10px from the right */
        width: 250x; /* Adjust width as needed */
        height: auto; /* Maintain aspect ratio */
      }
      .icon-button {
        background: none;
        border: none;
        padding: 10px;
        cursor: pointer;
        border-radius: 15px;
        transition: background 0.3s ease, color 0.3s ease;
      }

      .icon-button img {
        width: 20px; /* Adjust icon size as needed */
        height: auto;
        filter: invert(1); /* Invert the icon color to white */
      }

      .icon-button.red img {
        filter: invert(0) hue-rotate(180deg) saturate(10); /* Red color */
      }

      .input-group.centered {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
      }

      .text-input.rounded {
        border-radius: 5px;
        padding: 5px;
        margin-right: 5px;
      }
      .user-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
      }

      .user-checkbox {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.2);
        padding: 5px;
        border-radius: 5px;
      }

      .settings.frosted {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        backdrop-filter: blur(10px);
        padding: 5px 10px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .settings.frosted:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    </style>
  </head>

  <body>
    <div id="videos" class="container"></div>

    <div class="button-container">
      <div>
        <button id="muteButton" class="settings" onclick="toggleMute()">
          Mute
        </button>
        <button id="vidButton" class="settings" onclick="toggleVid()">
          Video
        </button>
      </div>

      <div class="input-group centered">
        <input
          type="text"
          id="newTextInput"
          class="text-input rounded"
          placeholder="Enter new text here"
        />
        <button
          id="newTextButton"
          class="settings frosted"
          onclick="handleNewTextInput()"
        >
          Submit
        </button>
      </div>
    </div>
    <video id="localVideo" class="vid" autoplay muted></video>
    <div id="chat-container">
      <div id="user-list" class="user-list"></div>
      <div id="chat-messages"></div>
      <input
        type="text"
        id="message-input"
        placeholder="Type your message..."
      />
      <button id="send-message" class="settings" onclick="sendMessage()">
        Send
      </button>
    </div>


    <h1>Real-time Speech to Text</h1>

    <div id="caption-messages"></div>
    
    <div id="controls">
      <select id="language">
        <option value="en">English</option>
        <option value="hi">Hindi</option>
      </select>
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop Recording</button>
    </div>
    <div id="output"></div>

    

    <footer>
      <script src="/js/main.js" lang="text/javascript"></script>
      <script>
        // Add this inline script to ensure sendMessage is defined before use
        function sendMessageHandler() {
          // This will call the sendMessage function from main.js
          if (typeof sendMessage === "function") {
            sendMessage();
          } else {
            console.error("sendMessage function is not defined");
          }
        }
      </script>

      <script>
        // AudioWorklet processor code as a string
        const workletCode = `
      class AudioProcessor extends AudioWorkletProcessor {
          constructor() {
              super();
              this.bufferSize = 8192;
              this.buffer = new Float32Array(this.bufferSize);
              this.bufferedSamples = 0;
          }

          process(inputs, outputs, parameters) {
              const input = inputs[0][0];
              if (!input) return true;

              // Add incoming samples to buffer
              for (let i = 0; i < input.length; i++) {
                  this.buffer[this.bufferedSamples] = input[i];
                  this.bufferedSamples++;

                  // When buffer is full, send it to main thread
                  if (this.bufferedSamples >= this.bufferSize) {
                      const int16Data = new Int16Array(this.bufferSize);
                      for (let j = 0; j < this.bufferSize; j++) {
                          int16Data[j] = Math.max(-32768, Math.min(32767, this.buffer[j] * 32768));
                      }
                      this.port.postMessage(int16Data.buffer, [int16Data.buffer]);
                      
                      // Reset buffer
                      this.buffer = new Float32Array(this.bufferSize);
                      this.bufferedSamples = 0;
                  }
              }
              return true;
          }
      }
      registerProcessor('audio-processor', AudioProcessor);
  `;

        let websocket;
        let audioContext;
        let workletNode;
        const outputDiv = document.getElementById("output");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const languageSelect = document.getElementById("language");

        async function initAudioWorklet() {
          const blob = new Blob([workletCode], {
            type: "application/javascript",
          });
          const workletUrl = URL.createObjectURL(blob);
          await audioContext.audioWorklet.addModule(workletUrl);
          URL.revokeObjectURL(workletUrl);
        }

        startBtn.onclick = async () => {
          try {
            // Connect to WebSocket server
            websocket = new WebSocket("ws://localhost:8765");

            websocket.onopen = () => {
              websocket.send(
                JSON.stringify({
                  language: languageSelect.value,
                })
              );
            };

            websocket.onmessage = (event) => {
              const data = JSON.parse(event.data);
              if (data.type === "final") {
                // Set the transcribed text to the message input field
                const messageInput = document.getElementById("message-input");
                messageInput.value = data.text;

                // Call the sendMessage function to send the transcribed message
                if (typeof sendCaption === "function") {
                  sendCaption();
                } else {
                  console.error("sendMessage function is not defined");
                }
              }
            };

            // Get audio stream
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });

            // Initialize audio context and worklet
            audioContext = new AudioContext({
              sampleRate: 16000, // Match Vosk's expected sample rate
              latencyHint: "interactive",
            });

            await initAudioWorklet();

            const source = audioContext.createMediaStreamSource(stream);
            workletNode = new AudioWorkletNode(audioContext, "audio-processor");

            workletNode.port.onmessage = (e) => {
              if (websocket.readyState === WebSocket.OPEN) {
                websocket.send(e.data);
              }
            };

            source.connect(workletNode);
            workletNode.connect(audioContext.destination);

            startBtn.disabled = true;
            stopBtn.disabled = false;
          } catch (error) {
            console.error("Error:", error);
            alert("Error starting recording: " + error.message);
          }
        };

        stopBtn.onclick = () => {
          if (websocket) {
            websocket.close();
          }
          if (workletNode) {
            workletNode.disconnect();
            workletNode = null;
          }
          if (audioContext) {
            audioContext.close();
            audioContext = null;
          }
          startBtn.disabled = false;
          stopBtn.disabled = true;
        };
      </script>
    </footer>
  </body>
</html>
